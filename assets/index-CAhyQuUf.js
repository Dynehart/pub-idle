var e,t=Object.defineProperty,s=(e,s,i)=>((e,s,i)=>s in e?t(e,s,{enumerable:!0,configurable:!0,writable:!0,value:i}):e[s]=i)(e,"symbol"!=typeof s?s+"":s,i);import{r as i}from"./phaser-DJe_tbjO.js";!function(){const e=document.createElement("link").relList;if(!(e&&e.supports&&e.supports("modulepreload"))){for(const e of document.querySelectorAll('link[rel="modulepreload"]'))t(e);new MutationObserver(e=>{for(const s of e)if("childList"===s.type)for(const e of s.addedNodes)"LINK"===e.tagName&&"modulepreload"===e.rel&&t(e)}).observe(document,{childList:!0,subtree:!0})}function t(e){if(e.ep)return;e.ep=!0;const t=function(e){const t={};return e.integrity&&(t.integrity=e.integrity),e.referrerPolicy&&(t.referrerPolicy=e.referrerPolicy),"use-credentials"===e.crossOrigin?t.credentials="include":"anonymous"===e.crossOrigin?t.credentials="omit":t.credentials="same-origin",t}(e);fetch(e.href,t)}}();var a=i();class n extends Error{constructor(e){super(e=e?`missing player object in class: ${e}`:"missing player object in class")}}class r extends Error{constructor(e){super(`class ${e} was not initialized correctly`)}}const o=()=>{const e=new WeakMap;return(t,s,i)=>{const a=i.value;if(!1===((e,t)=>"update"!==t?(console.error(new Error("must be used on update")),!1):"function"==typeof e&&2===e.length)(a,s))throw new Error("you fucked up a decorator dawg");return i.value=function(t,s){const i=e.get(this)??0;t>5e3*i&&(e.set(this,i+1),console.log(`[UPDATE] ${this.constructor.name}`)),a.call(this,t,s)},i}},h="MainMenu",c="UpgradeTree",l="Preloader",d="MainScene",p="IdleScene",u="ActionScene",g="Portal";var m=Object.defineProperty,y=Object.getOwnPropertyDescriptor;class f extends Phaser.Scene{constructor(){super("Boot"),s(this,"gameScene"),s(this,"sceneRunning",null),s(this,"sceneStopped",!0)}preload(){}create(){this.cameras.main.setBackgroundColor("#FFF000"),this.cameras.main.setBackgroundColor("#CDD7E1"),this.launchScene(l)}launchScene(e,t){this.scene.launch(e,t),this.gameScene=this.scene.get(e)}updateResize(e){e.scale.on("resize",this.resize,e);const t=e.scale.gameSize.width,s=e.scale.gameSize.height;e.parent=new Phaser.Structs.Size(t,s),e.sizer=new Phaser.Structs.Size(e.width,e.height,Phaser.Structs.Size.FIT,e.parent),e.parent.setSize(t,s),e.sizer.setSize(t,s),this.updateCamera(e)}resize(e){if(!this.sceneStopped){const t=e.width,s=e.height;this.parent.setSize(t,s),this.sizer.setSize(t,s);const i=this.cameras.main,a=this.sizer.width/this.game.screenBaseSize.width,n=this.sizer.height/this.game.screenBaseSize.height;i.setZoom(Math.max(a,n)),i.centerOn(this.game.screenBaseSize.width/2,this.game.screenBaseSize.height/2)}}updateCamera(e){const t=e.cameras.main,s=e.sizer.width/this.game.screenBaseSize.width,i=e.sizer.height/this.game.screenBaseSize.height;t.setZoom(Math.max(s,i)),t.centerOn(this.game.screenBaseSize.width/2,this.game.screenBaseSize.height/2)}update(e,t){}}((e,t,s)=>{for(var i,a=y(t,s),n=e.length-1;n>=0;n--)(i=e[n])&&(a=i(t,s,a)||a);a&&m(t,s,a)})([o()],f.prototype,"update");const w=(e,t)=>e in t,b="idleGameSave";class x extends Error{constructor(e){e??(e="unknown save error"),super(`save error: ${e}`)}}class v{constructor({upgradeManager:e,getCoins:t,setCoins:i}){s(this,"upgradeManager"),s(this,"getCoins"),s(this,"setCoins"),this.upgradeManager=e,this.getCoins=t,this.setCoins=i}save(){const e={coins:this.getCoins(),upgrades:this.upgradeManager.save()};try{localStorage.setItem(b,JSON.stringify(e)),console.log("[Game Saved]")}catch(t){if(!(t instanceof x))throw t;console.warn("Failed to save game:",t)}}load(){const e=localStorage.getItem(b);var t;if(e)try{const s=JSON.parse(e);if(null===(t=s)||"object"!=typeof t||!w("coins",t)||!w("upgrades",t))throw new x("");this.setCoins(s.coins),this.upgradeManager.load(s),console.log("[Game Loaded]")}catch(s){console.warn("Failed to load save:",s)}}clear(){this.upgradeManager.clear(),localStorage.removeItem(b),console.log("[Save Cleared]")}}class k{constructor(e){s(this,"scene"),s(this,"container"),s(this,"bg"),s(this,"text"),s(this,"tween"),s(this,"currentPointer"),s(this,"followPointer",e=>{if(!this.currentPointer)return;const t=e.x+12,s=e.y+12;this.container.setPosition(t,s)}),this.scene=e,this.bg=this.scene.add.graphics(),this.text=this.scene.add.text(12,12,"",{fontSize:"16px",color:"#ffffff",wordWrap:{width:236}}),this.container=this.scene.add.container(0,0,[this.bg,this.text]).setDepth(1e3).setAlpha(0).setVisible(!1),this.text.on("changedata",()=>{this.updateBackground()})}updateBackground(){const e=this.text.getBounds();this.bg.clear(),this.bg.fillStyle(0,.85),this.bg.fillRoundedRect(0,0,e.width+24,e.height+24,10)}show(e,t,s){this.text.setText(e),this.updateBackground(),this.container.setPosition(t+12,s+12),this.container.setVisible(!0),this.container.setAlpha(0),this.container.setScale(.95),this.tween&&this.tween.stop(),this.tween=this.scene.tweens.add({targets:this.container,alpha:1,scale:1,duration:250,ease:"Power2"}),this.currentPointer=this.scene.input.activePointer,this.scene.input.on("pointermove",this.followPointer,this)}hide(){this.tween&&this.tween.stop(),this.tween=this.scene.tweens.add({targets:this.container,alpha:0,scale:.95,duration:200,ease:"Power2",onComplete:()=>{this.container.setVisible(!1),this.scene.input.off("pointermove",this.followPointer,this),this.currentPointer=void 0}})}}class P extends a.GameObjects.Layer{constructor(e,t){super(e,t),s(this,"sprites"),e.add.existing(this)}Add(e){this.add(e)}}class S extends a.GameObjects.Sprite{constructor({scene:e,x:t,y:i,texture:a,type:n}){super(e,t,i,a),s(this,"type"),this.type=n}}const M=e=>"clicker"===e||"bot"===e||"printer"===e;function _(e){const{baseCost:t,level:s,linearFactor:i,multiplicativeFactor:a,exponentialFactor:n}=e,r=s*i,o=Math.pow(a,s),h=Math.pow(s||1,n);return Math.floor(t+r*o*h)}const I={clicker:{name:"Auto Clicker",description:"Automatically clicks once per second.",level:0,baseCost:10,cost:10,linearFactor:5,multiplicativeFactor:1.15,exponentialFactor:1.05,index:0,group:0,incomePerSecond:1,productionInterval:1e3,productionAmount:1,progress:0,lastProductionTime:performance.now()},bot:{name:"Worker Bot",description:"Automatically clicks 10x per second.",level:0,baseCost:100,cost:100,linearFactor:25,multiplicativeFactor:1.2,exponentialFactor:1.1,index:1,group:0,incomePerSecond:10,productionInterval:5e3,productionAmount:10,progress:0,lastProductionTime:performance.now()},printer:{name:"Money Printer",description:"Automatically clicks 100x per second.",level:0,baseCost:1e3,cost:1e3,linearFactor:100,multiplicativeFactor:1.5,exponentialFactor:1.2,index:2,group:0,incomePerSecond:100,productionInterval:1e3,productionAmount:100,progress:0,lastProductionTime:performance.now()}};class T{constructor(e){s(this,"upgradeUI"),s(this,"upgrades"),this.upgrades=((e,t)=>{const s=new Map;return Object.entries(e).forEach(([e,i],a)=>{t(e)&&s.set(e,i)}),s})(I,M),this.upgradeUI=e,this.recalculateAllCosts()}updateProduction(e){let t=0;return this.upgrades.forEach(s=>{if(0===s.level)return;const i=(e-s.lastProductionTime)/s.productionInterval;i>=1&&(t+=s.productionAmount*s.level,s.lastProductionTime=e),s.progress=i%1}),this.updateProgresses(),t}getAll(){return this.upgrades}updateProgresses(){this.upgradeUI.updateProgress(this.upgrades)}buy(e,t){const s=this.upgrades.get(e);if(!s)throw new Error("something about the mapping func is broken");if(t<s.cost)return 0;const i=s.cost;return s.level+=1,s.cost=_(s),this.updateProgresses(),i}recalculateAllCosts(){this.upgrades.forEach(e=>{e.cost=_(e)})}save(){const e={clicker:void 0,bot:void 0,printer:void 0};return this.upgrades.forEach(({level:t,progress:s},i)=>{e[i]={level:t,progress:s}}),e}load(e){this.upgrades.forEach((t,s)=>{const i=e.upgrades[s];i&&(t.level=i.level,t.progress=i.progress)}),this.updateProgresses()}clear(){this.upgrades.forEach((e,t)=>{const s=I[t];e.level=s.level,e.progress=s.progress})}}class C{constructor({scene:e,tooltipManager:t,x:i,y:a,description:n,onBuy:r}){s(this,"scene"),s(this,"tooltipManager"),s(this,"buttonWidth",1200),s(this,"buttonHeight",480),s(this,"rect"),s(this,"progressBar"),s(this,"label"),s(this,"emitter"),s(this,"upgrade"),this.scene=e,this.tooltipManager=t,this.rect=this.scene.add.rectangle(i,a,this.buttonWidth,this.buttonHeight,30464).setInteractive(),this.label=this.scene.add.text(i,a,"",{fontSize:80,color:"#ffffff",align:"center"}).setOrigin(.5),this.emitter=this.scene.add.particles(i,a,"flares",{frame:["red","yellow","green"],lifespan:500,speed:{min:150,max:250},scale:{start:.8,end:0},gravityY:150,blendMode:"ADD",emitting:!1}),this.rect.on("pointerover",e=>{this.tooltipManager.show(n,e.x,e.y)}),this.rect.on("pointerout",()=>{this.tooltipManager.hide()}),this.rect.on("pointerdown",()=>{r(),this.emitter.explode(16)}),this.progressBar=this.scene.add.graphics(),this.updateProgressBar(0)}update(e){this.updateProgressBar(e.progress),this.label.setText(`${e.name}\nLvl: ${e.level} | Cost: ${e.cost}`)}updateProgressBar(e){const t=a.Math.RoundTo(.05*this.buttonWidth),s=a.Math.RoundTo(.01*this.buttonHeight),i=this.buttonWidth-t,n=a.Math.RoundTo(.1*this.buttonHeight)-s,r=this.rect.x-i/2,o=this.rect.y+this.buttonHeight/2-n-10;this.progressBar.clear(),this.progressBar.fillStyle(2236962,1),this.progressBar.fillRect(r,o,i,n),e&&(this.progressBar.fillStyle(65280,1),this.progressBar.fillRect(r,o,i*a.Math.Clamp(e,0,1),n))}}class E{constructor(e,t){s(this,"scene"),s(this,"tooltipManager"),s(this,"buttons",{clicker:void 0,bot:void 0,printer:void 0}),s(this,"buttonWidth",1200),s(this,"buttonHeight",480),s(this,"spacingX",this.buttonWidth+20),s(this,"spacingY",this.buttonHeight+20),s(this,"startX",this.buttonWidth/2+40),s(this,"startY",this.buttonHeight/2+40),this.scene=e,this.tooltipManager=t}create(e,t){e.forEach((e,s)=>{const i=this.startY+e.index*this.spacingY,a=this.startX+e.group*this.spacingX,n=new C({scene:this.scene,tooltipManager:this.tooltipManager,x:a,y:i,description:e.description,onBuy:()=>{t(s)}});this.buttons[s]=n}),this.updateProgress(e)}updateProgressBar(e,t,s){const i=this.buttonWidth-20,n=this.buttonHeight/10,r=t.x-i/2,o=t.y+this.buttonHeight/2-n-10;e.clear(),e.fillStyle(2236962,1),e.fillRect(r,o,i,n),s&&(e.fillStyle(65280,1),e.fillRect(r,o,i*a.Math.Clamp(s,0,1),n))}updateProgress(e,t){e.forEach((e,t)=>{const s=this.buttons[t];s&&s.update(e)})}}class R extends a.Scene{constructor(){super("Game"),s(this,"coins",10),s(this,"coinText"),s(this,"mode","clickable"),s(this,"upgradeManager"),s(this,"upgradeUI"),s(this,"saveManager"),s(this,"buyUpgrade",e=>{this.upgradeManager&&(this.coins-=this.upgradeManager.buy(e,this.coins))})}create(){const e=new k(this);this.upgradeUI=new E(this,e),this.upgradeManager=new T(this.upgradeUI),this.saveManager=new v({upgradeManager:this.upgradeManager,getCoins:()=>this.coins,setCoins:e=>{var t;this.coins=e,null==(t=this.coinText)||t.setText(`Coins: ${this.coins}`)}}),this.coinText=this.add.text(this.scale.width/2,50,"Coins: 0",{fontSize:"32px",color:"#ffffff"}).setOrigin(.5),this.setupClickToEarn(),this.saveManager.load(),this.upgradeUI.create(this.upgradeManager.getAll(),this.buyUpgrade),this.time.addEvent({delay:1e4,loop:!0,callback:()=>{var e;null==(e=this.saveManager)||e.save()}}),this.setupClear(),window.addEventListener("beforeunload",()=>{var e;null==(e=this.saveManager)||e.save()}),this.sprite()}setupClear(){const e=this.add.particles(400,250,"flares",{frame:["red","yellow","green"],lifespan:4e3,speed:{min:150,max:250},scale:{start:.8,end:0},gravityY:150,blendMode:"ADD",emitting:!1});this.add.rectangle(this.scale.width*(15/16),this.scale.height*(15/16),this.scale.width/16,this.scale.height/16,15728640,.5).setOrigin(.5).setInteractive().on("pointerdown",()=>{var t;this.coins=0,null==(t=this.saveManager)||t.clear(),e.explode(16)})}setupClickToEarn(){"clickable"===this.mode&&this.add.rectangle(this.scale.width/2,this.scale.height/2-100,this.scale.width,this.scale.height/2,0,0).setInteractive().on("pointerdown",()=>{this.addCoins(1)})}sprite(){this.anims.create({key:"walk",frames:this.anims.generateFrameNumbers("brawler",{frames:[0,1,2,3]}),frameRate:8,repeat:-1}),this.anims.create({key:"idle",frames:this.anims.generateFrameNumbers("brawler",{frames:[5,6,7,8]}),frameRate:8,repeat:-1}),this.anims.create({key:"kick",frames:this.anims.generateFrameNumbers("brawler",{frames:[10,11,12,13,10]}),frameRate:8,repeat:-1,repeatDelay:2e3}),this.anims.create({key:"punch",frames:this.anims.generateFrameNumbers("brawler",{frames:[15,16,17,18,17,15]}),frameRate:8,repeat:-1,repeatDelay:2e3}),this.anims.create({key:"jump",frames:this.anims.generateFrameNumbers("brawler",{frames:[20,21,22,23]}),frameRate:8,repeat:-1}),this.anims.create({key:"jumpkick",frames:this.anims.generateFrameNumbers("brawler",{frames:[20,21,22,23,25,23,22,21]}),frameRate:8,repeat:-1,repeatDelay:4e3}),this.anims.create({key:"win",frames:this.anims.generateFrameNumbers("brawler",{frames:[30,31]}),frameRate:8,repeat:-1,repeatDelay:2e3}),this.anims.create({key:"die",frames:this.anims.generateFrameNumbers("brawler",{frames:[35,36,37]}),frameRate:8});const e=new P(this,void 0);this.anims.create({key:"sticky-walk",frames:this.anims.generateFrameNumbers("stick",{start:0,end:69}),frameRate:60,repeat:-1});const t=new S({scene:this,x:200,y:370,texture:"",type:"bot"});e.add(t),t.play("sticky-walk");for(let s=0;s<8;s++){const t=new S({scene:this,x:100+100*s,y:370,texture:"",type:"bot"});t.setScale(4),setTimeout(()=>{e.add(t),t.play("jumpkick"),setInterval(()=>{t.setPosition(t.x+50,t.y+50)},5e3)},1e3*s)}}update(e,t){var s,i;const a=null==(s=this.upgradeManager)?void 0:s.updateProduction(e);a&&a>0&&this.addCoins(a),null==(i=this.upgradeManager)||i.updateProgresses()}addCoins(e){var t;this.coins+=e,null==(t=this.coinText)||t.setText(`Coins: ${this.coins}`)}}class D extends Phaser.GameObjects.Image{constructor(e,t,i){var a,n;super(e.scene,t,i,"menu-item"),s(this,"text"),s(this,"onClick",e=>{}),e.scene.add.existing(this),this.setInteractive(),this.text=e.scene.add.text(this.width/2+t,this.height/2+i,"",{fontSize:40,color:"#ffffff",stroke:"#000000",strokeThickness:8,align:"center"}).setOrigin(.5,.5).setShadow(5,5,"#5588EE",0,!0,!0),e.add(this.text),this.on("pointerup",e=>{this.onClick(e)}),this.on("pointerover",t=>{this.scene.input.setDefaultCursor("pointer"),e.tween.restart(this),this.setRotation(Math.PI/32),setTimeout(()=>{this.setRotation(0)},50)}),this.on("pointerout",t=>{this.scene.input.setDefaultCursor("auto"),e.tween.pause(),this.setRotation(0).setTint(16777215)}),null==(a=this.preFX)||a.setPadding(16),null==(n=this.preFX)||n.addShadow()}}s(D,"texture","menu-item");class A{constructor(e,t,i){s(this,"tween"),s(this,"target"),this.tween=e.tweens.addCounter({paused:!0,persist:!0,from:t,to:i,duration:200,onUpdate:e=>{if(!this.target)return;let t=e.getValue();if(null===t)throw new Error("invalid tween");t=Math.floor(t),this.target.setTint(Phaser.Display.Color.GetColor(t,t,t))}})}restart(e){this.target=e,this.tween.resume()}pause(){this.target=void 0,this.tween.pause().seek(0)}}const F=10;class K extends Phaser.GameObjects.Container{constructor(e,t){super(e,t.x,t.y),s(this,"buttonWidth"),s(this,"buttonHeight"),s(this,"bg"),s(this,"buttons",[]),s(this,"width"),s(this,"tween"),this.scene=e,this.scene.add.existing(this),this.setVisible(!1);const i=this.scene.textures.get(D.texture).getFrameBounds(),a=this.scene.textures.get("close-icon").getFrameBounds();this.buttonHeight=i.height,this.buttonWidth=i.width,this.width=this.buttonWidth+20,this.bg=this.scene.add.tileSprite(0,0,this.menuWidth(1),this.menuHeight(2),"repeating-background").setOrigin(0,0),this.add(this.bg);const n=this.scene.add.image(this.buttonWidth-a.width/2+F,a.height/2+F,"close-icon").setInteractive();n.on("pointerover",e=>{this.scene.input.setDefaultCursor("pointer"),n.setScale(1.1),setTimeout(()=>{this.setScale(1)},50)}),n.on("pointerout",e=>{this.scene.input.setDefaultCursor("auto"),n.setScale(1)}),n.on("pointerup",e=>{this.setVisible(!1)}),this.add(n),this.tween=new A(this.scene,255,204)}menuWidth(e){return this.width=this.buttonWidth+20,this.width}menuHeight(e){const t=10*Math.max(e-1,0);return e*this.buttonHeight+t+20+100}createButton(e){const t=new D(this,F,F+(this.buttonHeight+F)*e+100);return t.setPosition(t.width/2+F,t.height/2+(this.buttonHeight+F)*e+100),this.buttons.push(t),this.add(t),t.text.setAbove(t),t}open(e,t){this.setPosition(e,t).setVisible(!0)}setButtons(e){for(let t=0;t<e.length;t++){const s=e[t];if(!s)throw new Error("invalid type");const i=this.buttons[t]??this.createButton(t);i.onClick=s.onClick,i.text.text=s.text}this.bg.setSize(this.menuWidth(1),this.menuHeight(e.length));for(let t=e.length;t<this.buttons.length;t++){const e=this.buttons[t];if(!e)return;e.setVisible(!1).text.setVisible(!1)}}}class O extends Phaser.Physics.Arcade.Sprite{constructor(e,t,i,a){super(e,i.x,i.y,"pickaxe"),s(this,"container"),s(this,"newTween"),s(this,"glow"),s(this,"new",!0),this.scene=e,this.resourceType=t,this.scene.add.existing(this),this.scene.physics.add.existing(this),this.setImmovable(!0),this.scene.player&&this.scene.physics.add.collider(this.scene.player,this,()=>{},()=>{},this),this.setScale(.5),this.container=new K(e,i),this.container.setButtons(a);const n=e.tweens.addCounter({paused:!0,persist:!0,from:255,to:204,duration:200,onUpdate:e=>{let t=e.getValue();if(null===t)throw new Error("invalid tween");t=Math.floor(t),this.setTint(Phaser.Display.Color.GetColor(t,t,t))}});this.on("pointerover",e=>{this.scene.input.setDefaultCursor("pointer"),n.play(),this.setRotation(Math.PI/32),setTimeout(()=>{this.setRotation(0)},50)}),this.on("pointerout",e=>{this.scene.input.setDefaultCursor("auto"),n.pause().seek(0),this.clearTint(),this.setRotation(0)}),this.on("pointerup",e=>{this.disableNew(),this.container.open(this.scene.scale.gameSize.width-this.container.width,0)}),this.setInteractive(),this.on("update",e=>{console.log(e)}),this.enableNew()}setButtons(e){this.container.setButtons(e)}enableNew(){var e,t,s;null==(e=this.preFX)||e.setPadding(32),null==(t=this.preFX)||t.addShadow(),this.glow=null==(s=this.preFX)?void 0:s.addGlow(16762624),this.newTween=this.scene.tweens.add({targets:this.glow,outerStrength:100,yoyo:!0,loop:-1,ease:"sine.inout",duration:1e3})}disableNew(){var e,t,s,i;this.new&&(this.new=!1,this.glow&&(null==(e=this.preFX)||e.remove(this.glow)),null==(t=this.preFX)||t.setPadding(16),this.glow=null==(s=this.preFX)?void 0:s.addGlow(16777215,100),null==(i=this.preFX)||i.addShadow(),this.newTween.stop())}attention(){!1!==this.new&&(this.setRotation(Math.PI/32),this.scene.time.delayedCall(50,()=>{this.setRotation(0)}),Math.random()<.3&&(this.scene.time.delayedCall(100,()=>{this.setRotation(Math.PI/32)}),this.scene.time.delayedCall(150,()=>{this.setRotation(0)})),this.scene.time.delayedCall(1750+500*Math.random(),()=>{this.attention()}))}}var z=Object.defineProperty,B=Object.getOwnPropertyDescriptor;class L extends Phaser.Physics.Arcade.Sprite{constructor(e,t,i,a=1){super(e,t.x,t.y,""),s(this,"level"),s(this,"debugText"),s(this,"xpBase",1.2),s(this,"xp"),s(this,"xpRequired"),s(this,"task","idle"),s(this,"speed",100),s(this,"travelTime",1e4),s(this,"travelElapsed",0),s(this,"distance",0),s(this,"carrying",0),s(this,"resourceContainer"),s(this,"miningTime",500),s(this,"miningElapsed",0),s(this,"resourceTarget"),this.scene=e,this.base=t,this.setOrigin(.5,.5).setScale(2),this.scene.add.existing(this),this.scene.physics.add.existing(this),this.scene.player&&(this.scene.physics.add.collider(this.scene.player,this,()=>{},()=>{},this),this.setBounce(.25)),this.resourceContainer=i,this.level=a,this.xp=this.xpBase**a,this.xpRequired=this.xpBase**(a+1),this.resourceTarget=void 0,this.debugText=this.scene.add.text(this.x,this.y,"",{fontFamily:"Arial Black",fontSize:20,color:"#ffffff",stroke:"#000000",strokeThickness:4,align:"center"}),this.play("idle")}assignResource(e){if(this.resourceTarget=e,e){const t=this.base.x-e.x,s=this.base.y-e.y;this.distance=Math.sqrt(t*t+s*s)}}handleXp(){this.xp+=this.level,this.xp>=this.xpRequired&&(this.level+=1,this.xpRequired=this.xpBase**(this.level+1),this.travelTime=Math.max(Math.trunc(.9*this.travelTime),500),this.miningTime=Math.max(Math.trunc(.9*this.miningTime),100))}update(e,t){switch((e=>{try{throw new Error}catch(t){if(t instanceof Error){const s=/(\w+)@|at (\w+)\.(\w+) \(/g,i=t.stack;if(!i)return;const a=s.exec(i);if("update"!==(null==a?void 0:a[3]))throw new Error("must be used within an update method");if(a[2]!==e.constructor.name)throw new Error("idk how this would happen or why it would matter")}}if(e.body instanceof Phaser.Physics.Arcade.Body){const t=e.scene.add.graphics({lineStyle:{width:2,color:16711680},fillStyle:{color:16711680,alpha:.3}});t.strokeRect(e.body.left,e.body.top,e.body.width,e.body.height),e.scene.time.delayedCall(1,()=>{t.destroy()})}})(this),this.debugText.setPosition(this.x,this.y).setOrigin(0,1),this.debugText.text=`lvl: ${this.level} (${this.xp}/${this.xpRequired})\ntravel:\t${this.travelTime}\nmining:\t${this.miningTime}`,this.task){case"move":if(void 0===this.resourceTarget){this.task="deliver",this.play("deliver");break}this.moveTo(this.resourceTarget.x,this.resourceTarget.y,t),this.reached(this.resourceTarget)&&(this.task="mine",this.play("mine"),this.travelElapsed=0,this.miningElapsed=0);break;case"mine":if(void 0===this.resourceTarget){this.task="deliver",this.play("deliver");break}if(!this.reached(this.resourceTarget)){this.task="move",this.play("move");break}if(this.miningElapsed+=t,this.miningElapsed>=this.miningTime){if(this.carrying+=this.resourceTarget.mine(this.level-this.carrying),this.carrying<this.level)return this.resourceTarget=void 0,this.task="move",void this.play("move");this.task="deliver",this.play("move")}break;case"celebrate":if("deliver"===this.anims.getName())break;this.handleXp(),this.play("deliver"),setTimeout(()=>{this.task="move",this.play("move")},250);break;case"deliver":if(this.moveTo(this.base.x,this.base.y,t),this.reached(this.base)){if(this.resourceContainer.addResource(this.carrying),this.carrying=0,this.travelElapsed=0,void 0===this.resourceTarget){this.task="idle",this.play("idle");break}this.task="celebrate"}break;case"idle":void 0!==this.resourceTarget&&(this.task="move",this.play("move"))}}moveTo(e,t,s){const i=e-this.x,a=t-this.y,n=Math.sqrt(i*i+a*a),r=this.travelTime-this.travelElapsed;if(n>10){let e=n/r*1e3;e=Math.max(e,100);const t=Math.atan2(a,i),s=Math.cos(t)*e,o=Math.sin(t)*e;this.flipX=s<0,this.body instanceof Phaser.Physics.Arcade.Body&&(this.body.velocity.x/s<.1||this.body.velocity.y/o<.1)&&(console.log(s,o),this.setVelocity(s,o))}else this.setVelocity(0,0);this.travelElapsed+=s}moveToPosition(e,t,s){const i=e-this.x,a=t-this.y,n=Math.sqrt(i*i+a*a),r=this.travelTime-this.travelElapsed;if(n>1){let e=n/r*1e3;e=Math.max(e,100);const t=Math.atan2(a,i),o=Math.cos(t)*e*(s/1e3),h=Math.sin(t)*e*(s/1e3);this.flipX=o<0,this.x+=o,this.y+=h,console.log(o,h),this.setVelocity(e,e)}}reached(e){const t=e.x-this.x,s=e.y-this.y;return t*t+s*s<100}}((e,t,s)=>{for(var i,a=B(t,s),n=e.length-1;n>=0;n--)(i=e[n])&&(a=i(t,s,a)||a);a&&z(t,s,a)})([(()=>{let e=0;return function(t,s,i){const a=i.value;if("function"!=typeof a)throw new Error("you fucked up a decorator dawg");return i.value=function(...t){const s=console.log;console.log=(...t)=>{e%1==0&&console.trace(t)};try{return e++,a.apply(this,t)}finally{console.log=s}},i}})()],L.prototype,"moveTo");class j extends Phaser.Physics.Arcade.Image{constructor(e,t,i,a,n=1e3){const r=["00","16","32","48","64"],o=`${t}${r[Math.floor(Math.random()*r.length)]??"00"}`;super(e,i.x,i.y,"ores",o),s(this,"text"),this.scene=e,this.resourceType=t,this.position=i,this.size=a,this.amountLeft=n;const h=this.size/this.width;this.setScale(h),this.scene.physics.add.existing(this),this.text=this.scene.add.text(this.position.x,this.position.y,`${this.amountLeft}`,{fontSize:40}).setOrigin(.5,2),e.add.existing(this)}mine(e){const t=Math.min(e,this.amountLeft);return this.amountLeft-=t,this.text.setText(`${this.amountLeft}`),t}}class X extends Phaser.GameObjects.Text{constructor(e,t,i,a,n){super(e,t,i,a,n),s(this,"tween"),this.setVisible(!1),this.setAlpha(0)}}class q{constructor(e,t,i){var a;s(this,"drones",[]),s(this,"resourceNodes",[]),s(this,"nodes"),s(this,"notificationText"),s(this,"amountText"),s(this,"building"),s(this,"baseCost",10),s(this,"costMultiplier",1.2),s(this,"costExponent",1.05),s(this,"amount",1e3),s(this,"resourceSize",64),this.scene=e,this.type=t,this.probeBody=i,this.nodes=this.scene.physics.add.group(this.resourceNodes);const n=this.scene.add.rectangle(0,0,this.scene.scale.baseSize.width,this.scene.scale.baseSize.height,255,255).setInteractive().on("pointerdown",e=>{e.rightButtonDown()&&this.createNode(e)}).setOrigin(0);for(null==(a=this.scene.GameLayer)||a.add(n),this.building=new O(this.scene,this.type,{x:2e3,y:1e3},[{text:`Spawn Drone\n(${this.cost})`,tooltip:"1",onClick:()=>{this.createDrone()}}]),this.notificationText=this.scene.add.group({maxSize:15});15!==this.notificationText.children.size;){const e=new X(this.scene,this.building.x,this.building.y,"+1",{fontSize:40,color:N[this.type].toString(16),strokeThickness:8,align:"center"});e.tween=this.scene.tweens.add({paused:!0,persist:!0,targets:e,x:{from:this.building.x,to:this.building.x+50},y:{from:this.building.y-50,to:this.building.y-150},alpha:[1,.95,.9,.85,.8,.75,.7,.6,.5,0],duration:500}),this.notificationText.add(e,!0)}this.amountText=this.scene.add.text(20,60,"Resources: 0",{fontSize:80}),this.createNode({x:this.scene.scale.baseSize.width*(3/4),y:this.scene.scale.baseSize.height*(3/4)})}get cost(){const e=this.costMultiplier*this.drones.length,t=this.costExponent**this.drones.length-1;return Math.trunc(this.baseCost*(e+t))}update(e,t){var s;for(const i of this.drones){if(0===(null==(s=i.resourceTarget)?void 0:s.amountLeft)&&(i.resourceTarget.text.destroy(),this.nodes.remove(i.resourceTarget,!0,!0),i.assignResource(void 0)),!i.resourceTarget){const e=this.scene.physics.closest({x:i.x,y:i.y},this.nodes.getChildren());e&&e instanceof j&&i.assignResource(e)}i.update(e,t)}this.amountText.setText(`Resources: ${this.amount}`)}createDrone(){if(this.amount<this.cost)return;const e=new L(this.scene,this.building,this,1);this.amount-=this.cost,this.drones.push(e),this.scene.physics.add.collider(this.drones,e),this.scene.physics.overlap(this.drones,e),this.building.setButtons([{text:`Spawn Drone\n(${this.cost})`,tooltip:"1",onClick:()=>{this.createDrone()}}])}createNode(e){var t;e??(e={x:600,y:200}),this.probeBody.setEnable(!0).reset(e.x,e.y);const s=this.scene.physics.overlap(this.probeBody,this.nodes);if(this.probeBody.setEnable(!1),s)return;const i=new j(this.scene,this.type,e,this.resourceSize);return this.resourceNodes.push(i),null==(t=this.scene.ResourceLayer)||t.add(i),this.nodes.add(i),i}addResource(e){var t;this.amount+=e;const s=this.notificationText.getMatching("alpha",0),i=s[Math.trunc(s.length*Math.random())];let a;i instanceof X&&(a=i,a.text=`+${e}`,a.setVisible(!0),null==(t=a.tween)||t.restart())}consumeResource(e){return this.amount>=e&&(this.amount-=e,!0)}}const N={stone:5855577,copper:13857085,silver:14869218,gold:16634896};class U{constructor(e){s(this,"resources",new Map),s(this,"probeBody"),this.scene=e,this.probeBody=this.scene.physics.add.body(0,0,0,0).setEnable(!1)}update(e,t){for(const[,s]of this.resources)s.update(e,t)}initialize(e){const t=new q(this.scene,e,this.probeBody);this.resources.set(e,t)}createDrone(e){const t=this.resources.get(e);if(!t)throw new Error("meow");t.createDrone()}createNode(e){const t=this.resources.get(e);if(!t)throw new Error("meow");t.createNode()}addResource(e,t){const s=this.resources.get(e);if(!s)throw new Error("meow");s.addResource(t)}consumeResource(e,t){const s=this.resources.get(e);if(!s)throw new Error("meow");return s.consumeResource(t)}}const V=class e{constructor(t,i){if(s(this,"keys",new Map),s(this,"buttons",new Map),s(this,"gamepadPlugin"),s(this,"keyboardPlugin"),s(this,"gamepad"),s(this,"keyboard"),s(this,"keyses"),s(this,"setup",!1),s(this,"connected",!1),s(this,"onTab",()=>{}),s(this,"onPause",()=>{}),this.scene=t,this.num=i,null===this.scene.input.keyboard)throw new Error("missing keyboard plugin");if(this.keyboardPlugin=this.scene.input.keyboard,this.keyses={up:[this.keyboardPlugin.addKey(Phaser.Input.Keyboard.KeyCodes.W),this.keyboardPlugin.addKey(Phaser.Input.Keyboard.KeyCodes.UP)],left:[this.keyboardPlugin.addKey(Phaser.Input.Keyboard.KeyCodes.A),this.keyboardPlugin.addKey(Phaser.Input.Keyboard.KeyCodes.LEFT)],down:[this.keyboardPlugin.addKey(Phaser.Input.Keyboard.KeyCodes.S),this.keyboardPlugin.addKey(Phaser.Input.Keyboard.KeyCodes.DOWN)],right:[this.keyboardPlugin.addKey(Phaser.Input.Keyboard.KeyCodes.D),this.keyboardPlugin.addKey(Phaser.Input.Keyboard.KeyCodes.RIGHT)],pause:[this.keyboardPlugin.addKey(Phaser.Input.Keyboard.KeyCodes.ESC)],upgrade:[this.keyboardPlugin.addKey(Phaser.Input.Keyboard.KeyCodes.TAB)],shift:[this.keyboardPlugin.addKey(Phaser.Input.Keyboard.KeyCodes.SHIFT)]},this.keyses.upgrade[0].on("up",()=>{this.onTab()}),this.keyses.pause[0].on("up",()=>{this.onPause()}),null===this.scene.input.gamepad)throw new Error("missing gamepad plugin");if(this.gamepadPlugin=this.scene.input.gamepad,e.instance)return e.instance;e.instance=this}setupController(){this.setup||(this.gamepadPlugin.on("down",(e,t)=>{if(!(e instanceof Phaser.Input.Gamepad.Gamepad))throw new Error("types are wrong");if(!(t instanceof Phaser.Input.Gamepad.Button))throw new Error("types are wrong");t.index===Phaser.Input.Gamepad.Configs.XBOX_360.BACK&&this.onTab(),t.index===Phaser.Input.Gamepad.Configs.XBOX_360.START&&this.onPause()}),this.setup=!0)}updateConnection(){this.connected||(this.setupController(),this.gamepad=this.gamepadPlugin.gamepads[this.num],this.gamepad&&(this.connected=!0))}updateDisconnect(){this.connected&&(this.connected=!1)}get(e){let t=this.keys.get(e);t||(t=[],this.keys.set(e,t));let s=this.buttons.get(e);return s||(s=[],this.buttons.set(e,s)),{keys:t,buttons:s}}isDown(e){const{keys:t,buttons:s}=this.get(e);for(const i of t)if(i.isDown)return!0;for(const i of s)if(i.pressed)return!0;return!1}setOnTab(e){this.onTab=e}setOnPause(e){this.onPause=e}get aiming(){let e=this.keyses.shift[0].isDown;return this.gamepad&&(e=e||this.gamepad.L2>.5),e}target(e){var t,s;let{x:i,y:a}=this.scene.input.activePointer,n=Phaser.Math.Angle.Between(e.x,e.y,i,a);const r=null==(t=this.gamepad)?void 0:t.axes[2],o=null==(s=this.gamepad)?void 0:s.axes[3];if(void 0!==r&&void 0!==o&&(0!==r.value||0!==o.value)){const t=r.getValue(),s=o.getValue();n=Phaser.Math.Angle.Between(0,0,t,s),i=e.x,a=e.y}return{x:i,y:a,angle:n}}position(){let e=0,t=0;if(this.gamepad){const s=this.gamepad.axes[0],i=this.gamepad.axes[1];void 0!==s&&void 0!==i&&(e=s.getValue(),t=i.getValue())}const s=this.keyses.up[0].isDown||this.keyses.up[1].isDown,i=this.keyses.left[0].isDown||this.keyses.left[1].isDown,a=this.keyses.down[0].isDown||this.keyses.down[1].isDown;if(i&&(e-=1),(this.keyses.right[0].isDown||this.keyses.right[1].isDown)&&(e+=1),s&&(t-=1),a&&(t+=1),e<.1&&e>-.1&&(e=0),t<.1&&t>-.1&&(t=0),0===e&&0===t)return[e,t];const n=e**2+t**2;return n>1&&(e/=Math.sqrt(n),t/=Math.sqrt(n)),[e,t]}update(e,t){this.updateConnection()}};s(V,"instance");let $=V;const G={fontFamily:"Arial Black",fontSize:40,color:"#ffffff",stroke:"#000000",strokeThickness:8,align:"center"};var H=Object.defineProperty,W=Object.getOwnPropertyDescriptor;const Y=[p,u,g],Q=(e=class extends Phaser.Scene{constructor(){if(super(d),s(this,"GameLayer",null),s(this,"UILayer",null),s(this,"MenuLayer",null),s(this,"menuOpen",!1),s(this,"player"),s(this,"enemyManager"),s(this,"enemies",null),s(this,"inputProvider"),s(this,"keys"),s(this,"activeScene",p),s(this,"switchers",[]),s(this,"switcher",()=>{var e,t;if(this.scene.launch(this.activeScene),this.activeScene===h){const s=400,i=200;let a=this.scale.baseSize.width/2-s/2*(Y.length-1)-10*(Y.length-1);for(const n of Y){const r=this.add.rectangle(a,i/2,s,i,n===this.activeScene?30464:16711680).setInteractive().on("pointerup",()=>{console.log(this.scene.manager.getScenes()),this.launch(n);for(const e of this.switchers)e===r?e.setFillStyle(30464):e.setFillStyle(16711680)}),o=this.add.text(a,i/2,n,{fontSize:40,color:"#ffffff",stroke:"#000000",strokeThickness:8,align:"center"}).setOrigin(.5);null==(e=this.UILayer)||e.add(r),null==(t=this.UILayer)||t.add(o),this.switchers.push(r),a+=s+10}}}),e.instance)return e.instance;e.instance=this}create(){var e;if(this.GameLayer=this.add.layer(),this.UILayer=this.add.layer(),this.MenuLayer=this.add.layer().setVisible(!1).setDepth(10),null==(e=this.input.mouse)||e.disableContextMenu(),this.inputProvider=new $(this,0),!this.input.keyboard)throw new Error("why no keyboard?");this.switcher(),(e=>{const t=e.add.image(e.scale.width-16,16,"fullscreen",0).setOrigin(1,0).setInteractive();t.on("pointerup",()=>{console.log("width",e.scale.width,"height",e.scale.height),console.log("baseSize",e.scale.baseSize),console.log("gameSize",e.scale.gameSize),console.log("displaySize",e.scale.displaySize),console.log("displaySize",e.scale.displaySize.width,e.scale.displaySize.height),e.scale.isFullscreen?(t.setFrame(0),e.scale.stopFullscreen()):(t.setFrame(1),e.scale.startFullscreen())},void 0)})(this),this.keys={tab:this.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.TAB),esc:this.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.ESC)},this.inputProvider.setOnTab(()=>{this.show(c,this.activeScene)}),this.inputProvider.setOnPause(()=>{this.show(h,this.activeScene),this.menuOpen=!this.menuOpen})}show(e,t){const s=this.scene.isActive(e),i=this.scene.isVisible(e);s||this.scene.launch(e),this.cameras.main.setBackgroundColor(i?"rgba(0,0,0,0)":"rgba(0,0,0,32)"),this.scene.setVisible(!i,e),this.scene.setActive(!s,e),this.scene.setActive(s,t)}launch(e){this.menuOpen&&(this.show(h,this.activeScene),this.menuOpen=!this.menuOpen),this.scene.key===d?(this.scene.stop(this.activeScene),this.scene.launch(e)):this.scene.start(e),this.activeScene=e}update(e,t){this.inputProvider.update(e,t)}},s(e,"instance"),e);((e,t,s)=>{for(var i,a=W(t,s),n=e.length-1;n>=0;n--)(i=e[n])&&(a=i(t,s,a)||a);a&&H(t,s,a)})([o()],Q.prototype,"update");let J=Q;const Z=e=>{var t;if(e.health.curr<=0&&e.die(),e.health.bar||(e.health.bar=e.scene.add.graphics(),null==(t=e.scene.UILayer)||t.add(e.health.bar)),e.health.bar.clear(),e.health.curr===e.health.max||e.health.curr<=0)return;const s=e.x-50,i=e.y-50-30;e.health.bar.fillStyle(2236962,1),e.health.bar.fillRect(s,i,100,20);const a=100/e.health.max;e.health.bar.fillStyle(65280,1),e.health.bar.fillRect(s,i,Phaser.Math.Clamp(e.health.curr*a,0,100),20)};class ee extends Phaser.Physics.Arcade.Sprite{constructor(e,t,s,i,a){var n,r;super(e,t,s,"xp_25"),this.scene=e,this.dx=i,this.dy=a,this.setScale(.5),null==(n=this.preFX)||n.setPadding(32),null==(r=this.preFX)||r.addShadow(),this.scene.add.existing(this),this.scene.physics.add.existing(this)}update(){this.setPosition(this.x+this.dx,this.y+this.dy)}}const te=(e,t,s,i)=>(1-e)*(1-e)*t+2*(1-e)*e*s+e*e*i;class se extends Phaser.Physics.Arcade.Sprite{constructor(e,t,i,a,n,r=100,o=-.01){super(e,t,i,"xp_25"),s(this,"theta"),s(this,"speed"),s(this,"angularVelocity"),this.scene=e,this.speed=r,this.theta=Phaser.Math.Angle.Between(t,i,a,n),this.angularVelocity=o,this.setScale(.5),this.scene.add.existing(this),this.scene.physics.add.existing(this)}update(){this.theta+=this.angularVelocity;const e=this.speed/60*Math.cos(this.theta),t=this.speed/60*Math.sin(this.theta);this.setPosition(this.x+e,this.y+t)}}let ie=0;class ae extends Phaser.Physics.Arcade.Sprite{constructor(e,t,i,a,n,r,o){super(e,t,i,"xp_25"),s(this,"id"),s(this,"t",0),s(this,"speed",1/60),this.scene=e,this.startX=t,this.startY=i,this.controlX=a,this.controlY=n,this.endX=r,this.endY=o,this.id=ie++,this.setScale(.5),this.scene.add.existing(this),this.scene.physics.add.existing(this)}update(){if(this.t+=this.speed,this.t>1)return void this.destroy();const e=te(this.t,this.startX,this.controlX,this.endX),t=te(this.t,this.startY,this.controlY,this.endY);this.setPosition(e,t)}}const ne=Math.max(10,0),re=200,oe=100,he=150,ce=class e{constructor(){for(let t=0;t<240;t++){const t=Math.ceil(3*Math.random()),s=[];for(let e=0;e<t;e++){const i=Math.random()*((e+1)/t),a=160+80*Math.random();s.push({position:i,speed:a})}e.table.push(s)}}static next(){e.instance||(e.instance=new e),e.idx>=e.table.length&&(console.warn("random numbers exhausted"),e.idx=0);const t=e.table[e.idx++];if(void 0===t)throw new Error;return t}};s(ce,"idx",0),s(ce,"table",[]),s(ce,"instance");let le=ce;class de extends Phaser.Scene{constructor(){super("Portal"),s(this,"MainLayer",null),s(this,"ParticleLayer",null),s(this,"Particles",null),s(this,"center"),s(this,"_curve"),s(this,"_curveCurve"),s(this,"bounds"),s(this,"portal"),s(this,"_graphics"),s(this,"_graphics2"),s(this,"startImages",[]),s(this,"mainImages",[]),s(this,"text",null),s(this,"startFrame"),s(this,"downloading",!1),s(this,"downloaded",!1),s(this,"downloadedStart",!1)}get curve(){return this._curve||(this._curve=new Phaser.Curves.Ellipse(this.center.x,this.center.y,oe,he)),this._curve}get curveCurve(){if(!this._curveCurve){const e=3/4;this._curveCurve=new Phaser.Curves.Ellipse(this.center.x,this.center.y,oe*e,he*e)}return this._curveCurve}get graphics(){return this._graphics||(this._graphics=this.add.graphics(),this.graphics.clear(),this.graphics.lineStyle(10,41215,1),this.curve.draw(this.graphics,64)),this._graphics}get graphics2(){return this._graphics2||(this._graphics2=this.add.graphics(),this.graphics2.clear(),this.graphics2.lineStyle(10,41215,1),this.curveCurve.draw(this.graphics2,64)),this._graphics2}create(){this.MainLayer=this.add.layer().setDepth(10),this.ParticleLayer=this.add.layer(),this.center={x:this.scale.baseSize.width/2,y:this.scale.baseSize.height/2},this.cameras.main.setBackgroundColor("rgba(0,0,0,0)")}drawParticle(){var e;const t=le.next();for(const s of t){const{position:t,speed:i}=s,{x:a,y:n}=this.curve.getPoint(t);Phaser.Math.Angle.Between(a,n,this.center.x,this.center.y);const{x:r,y:o}=this.curveCurve.getPoint((t+.25)%1),h=new ae(this,a,n,r,o,this.center.x,this.center.y);this.Particles||(this.Particles=this.add.group(),this.Particles.runChildUpdate=!0),this.Particles.add(h),null==(e=this.ParticleLayer)||e.add(h),console.log(h.id)}}collision(){const e=this.physics.overlapCirc(this.center.x,this.center.y,5);for(const t of e){const e=t.gameObject;e instanceof ee&&e.destroy(),e instanceof se&&e.destroy(),e instanceof ae&&(console.log(e.id),e.destroy())}}drawPortal(){var e,t,s;if(!this.portal){const i="portal_builder";this.graphics.generateTexture(i,re+2*ne,300+2*ne),this.portal=this.add.sprite(this.center.x,this.center.y,i).setOrigin(.5),null==(e=this.portal.preFX)||e.setPadding(128),null==(t=this.portal.preFX)||t.addShadow(0,0,.1,10,41215),null==(s=this.MainLayer)||s.add(this.portal)}}mergeImagesToGrid(e,t=12){if(!e[0])throw new Error("missing img");const s=t,i=Math.floor(e.length/t),a=e[0].width,n=e[0].height,r=document.createElement("canvas");r.width=a*s,r.height=n*i;const o=r.getContext("2d");if(!o)throw new Error("no ctx");for(let l=0;l<e.length;l++){const t=e[l];if(!t)throw new Error(`missing img ${l}`);if(t.width!==re+2*ne)throw new Error(`incorrect width ${t.width}:200`);if(t.height!==300+2*ne)throw new Error(`incorrect height ${t.height}:300`);const i=l%s*a,r=Math.floor(l/s)*n;o.drawImage(t,i,r,a,n)}const h=o.getImageData(0,0,r.width,r.height);console.log(h);const c=h.data;for(let l=0;l<c.length;l+=4){const e=c[l+0],t=c[l+1],s=c[l+2];205===e&&215===t&&225===s&&(c[l+0]=0,c[l+1]=0,c[l+2]=0,c[l+3]=0)}return o.putImageData(h,0,0),r.toDataURL()}debug(){void 0===this.startFrame&&(this.startFrame=this.game.loop.frame),null===this.text&&(this.text=this.add.text(this.center.x,this.center.y-re,"",G),this.add.circle(this.center.x,this.center.y,5,16711680)),this.text.text=""+(this.game.loop.frame-this.startFrame)}update(e,t){if(this.drawPortal(),this.drawParticle(),this.mainImages.length<300){this.bounds||(this.bounds=this.curve.getBounds(void 0,64));const{x:e,y:t,width:s,height:i}=this.bounds;this.game.renderer.snapshotArea(e-ne,t-ne,s+2*ne,i+2*ne,e=>{e instanceof HTMLImageElement&&(this.mainImages.push(e),this.startImages.length<60&&this.startImages.push(e))})}else if(this.downloaded||this.downloading)!this.downloadedStart&&this.downloading;else{this.downloading=!0;const e=document.createElement("a");e.href=this.mergeImagesToGrid(this.mainImages),e.download=`portal_${re+2*ne}_${300+2*ne}.png`,e.click(),window.addEventListener("focus",e=>{this.downloaded=!0,this.downloading=!1})}this.collision()}}const pe=[1,5,25,125,625],ue="xp_",ge=["grid","castle","pebble","menu-item","border","border-wide","close-icon","pickaxe","sword","bow","arrow"],me=new Map([["grid","grid-ps2.png"],["castle","castle.png"],["pebble","pebble.gif"],["menu-item","border-wide.png"],["close-icon","close-icon.png"]]);class ye extends a.Scene{constructor(){super(l),s(this,"mode","game")}init(){this.add.image(512,384,"background"),this.add.rectangle(512,384,468,32).setStrokeStyle(1,16777215);const e=this.add.rectangle(282,384,4,28,16777215);this.load.on("progress",t=>{e.width=4+460*t})}preload(){this.load.setPath("assets"),this.load.image("logo","logo.png"),this.load.spritesheet("brawler","animations/brawler48x48.png",{frameWidth:48,frameHeight:48}),this.preloadTexture(),this.load.spritesheet("fullscreen","ui/fullscreen.png",{frameWidth:64,frameHeight:64}),this.load.atlas("flares","particles/flares.png","particles/flares.json"),this.load.spritesheet("stick","animations/stick.png",{frameWidth:180,frameHeight:339.375}),this.load.spritesheet("stick-head","animations/stick-head.png",{frameWidth:18,frameHeight:18}),this.load.spritesheet("drone","animations/drone.png",{frameWidth:34,frameHeight:34}),this.load.spritesheet("blobie-walk","animations/blobie-walk.png",{frameWidth:34,frameHeight:34}),this.load.spritesheet("char","animations/char.png",{frameWidth:34,frameHeight:34}),this.load.spritesheet("rat","animations/rat.png",{frameWidth:34,frameHeight:34}),this.load.spritesheet("blob","animations/blob.png",{frameWidth:34,frameHeight:34}),this.load.spritesheet("bat","animations/bat.png",{frameWidth:34,frameHeight:34}),this.load.spritesheet("portal","animations/portal_220_320.png",{frameWidth:220,frameHeight:320}),this.load.glsl("fire","shaders/fire.glsl"),this.load.image("repeating-background","textures/tile.png")}preloadXP(){for(const e of pe)this.load.image(`${ue}${e}`,`textures/xp/${e}.png`)}preloadTexture(){const e="textures";for(const t of ge){const s=me.get(t);void 0===s?this.load.image(t,`${e}/${t}.png`):this.load.image(t,`${e}/${s}`)}this.load.atlas("ores","textures/ores.png","textures/ores.json"),this.preloadXP()}create(){"portal"!==this.mode?(this.scene.add(g,de),this.scene.add(d,J),this.scene.swapPosition(d,"Game"),this.scene.start(d)):this.build()}build(){this.scene.start("Portal")}}class fe extends Phaser.Physics.Arcade.Sprite{constructor(e,t,i,a){var n,r,o;if(!1===pe.includes(a))throw new Error("invalid xp amount");super(e,t,i,`${ue}${a}`),s(this,"timer"),this.scene=e,this.amount=a,null==(n=e.xp)||n.add(this),null==(r=this.preFX)||r.setPadding(32),null==(o=this.preFX)||o.addShadow(),this.scene.add.existing(this),this.timer=this.scene.time.addEvent({delay:1e3,callback:()=>{this.collapse()},callbackScope:this,loop:!0})}destroy(e){this.timer.destroy(),super.destroy(e)}collapse(){const e=this.scene.physics.overlapCirc(this.x,this.y,250),t=new Set;for(const s of e){const e=s.gameObject;if(e instanceof fe&&e.amount===this.amount&&(t.add(e),5===t.size)){const e=5*this.amount;this.setTexture(`${ue}${e}`),this.amount=e;for(const s of t)s!==this&&s.destroy();t.clear()}}}}class we extends Phaser.Physics.Arcade.Sprite{constructor(e,t){var i,a,n;super(e,0,0,t.TEXTURE_KEY),s(this,"lastDmgTime",0),s(this,"applyDamage",!1),s(this,"health",{curr:0,max:0}),s(this,"healthBar",null),s(this,"id",crypto.randomUUID().slice(-4)),this.scene=e,this.info=t,this.setOrigin(.5,.5).setScale(2),this.health={curr:t.stats.health,max:t.stats.health},this.scene.physics.add.existing(this),this.scene.player&&this.scene.physics.add.collider(this.scene.player,this,()=>{this.applyDamage=!0}),null==(i=this.preFX)||i.setPadding(64),null==(a=this.preFX)||a.addShadow(),this.spawn(),null==(n=this.scene.enemies)||n.add(this)}enableNew(){}moveToRandomEdge(){let e=0,t=0;const s=Math.floor(4*Math.random());0===s?(e=Math.random()*this.scene.scale.width,t=0):1===s?(e=this.scene.scale.width,t=Math.random()*this.scene.scale.height):2===s?(e=Math.random()*this.scene.scale.width,t=this.scene.scale.height):3===s&&(e=0,t=Math.random()*this.scene.scale.height),this.setPosition(e,t)}damage(e){this.scene.player&&this.applyDamage&&(this.applyDamage=!1,this.lastDmgTime<e-this.info.stats.attackSpeed&&(this.lastDmgTime=e,this.scene.player.health.curr-=this.info.stats.damage))}dealDamage(e){this.health.curr-=e}spawn(e=1){const t=this.info.stats.health*1.02**(e-1);this.health.curr=t,this.health.max=t,this.setActive(!0),this.setVisible(!0),this.moveToRandomEdge(),this.body instanceof Phaser.Physics.Arcade.Body&&this.body.setEnable(!0)}die(){console.debug(this.id,"dead"),this.setVisible(!1),this.body instanceof Phaser.Physics.Arcade.Body&&this.body.setEnable(!1);const e=this.x,t=this.y;new fe(this.scene,e,t,this.info.loot.xp),this.setActive(!1)}update(e,t){Z(this),this.setVelocity(0),this.move(t),this.damage(e),this.reachedPlayer||this.play(this.info.FRAMES.MOVE,!0)}move(e){if(!this.scene.player)throw new n;if(this.reachedPlayer)return;const t=this.scene.player.x-this.x,s=this.scene.player.y-this.y;if(Math.sqrt(t*t+s*s)>1){const i=this.info.stats.moveSpeed*(1+.1*this.info.stats.level)/2,a=Math.atan2(s,t),n=Math.cos(a)*i*(e/1e3),r=Math.sin(a)*i*(e/1e3);this.flipX=n<0,this.x+=n,this.y+=r,this.setPosition(this.x+n,this.y+r)}}get reachedPlayer(){if(!this.scene.player)throw new n;const e=this.scene.player.x-this.x,t=this.scene.player.y-this.y;return e*e+t*t<this.info.stats.range**2}}class be extends Phaser.Physics.Arcade.Group{constructor(e,t){super(e.physics.world,e,t.config),this.scene=e,this.info=t,this.runChildUpdate=!0;for(const{key:s,config:i}of Object.values(this.info.FRAMES))this.scene.anims.create({key:s,frames:this.scene.anims.generateFrameNumbers(this.info.TEXTURE_KEY,i),frameRate:4,repeat:-1})}getFirstDead(){const e=super.getFirstDead(!1);return e instanceof we?e:!1===this.isFull()?new we(this.scene,this.info):void 0}spawn(e){for(let t=0;t<e;t++){const e=this.getFirstDead();e&&(e.spawn(),super.add(e,!0))}return this}add(){const e=new we(this.scene,this.info);return super.add(e,!0),this}}const xe=[{TEXTURE_KEY:"rat",FRAMES:{IDLE:{key:"rat-idle",config:{frames:[0,1]}},MOVE:{key:"rat-move",config:{frames:[0,1]}}},stats:{level:1,damage:5,attackSpeed:400,moveSpeed:150,health:5,range:50},loot:{xp:1},config:{maxSize:10},metadata:{startTime:0,spawn:[{rate:2e3,count:1,max:15},{rate:1e3,count:1,max:25},{rate:500,count:1,max:50},{rate:1e3,count:1,max:25},{rate:2e3,count:1,max:15}],lastSpawn:0}},{TEXTURE_KEY:"blob",FRAMES:{IDLE:{key:"blob-idle",config:{frames:[0,1]}},MOVE:{key:"blob-move",config:{frames:[0,1]}}},stats:{level:2,damage:20,attackSpeed:800,moveSpeed:100,health:10,range:50},config:{maxSize:10},loot:{xp:5},metadata:{startTime:60,spawn:[{rate:2e3,count:1,max:15},{rate:1e3,count:1,max:25},{rate:500,count:1,max:50},{rate:1e3,count:1,max:25},{rate:2e3,count:1,max:15}],lastSpawn:0}},{TEXTURE_KEY:"bat",FRAMES:{IDLE:{key:"bat-idle",config:{frames:[0,1]}},MOVE:{key:"bat-move",config:{frames:[0,1]}}},stats:{level:3,damage:5,attackSpeed:200,moveSpeed:250,health:5,range:250},config:{maxSize:25},loot:{xp:1},metadata:{startTime:120,spawn:[{rate:2e3,count:1,max:15},{rate:1e3,count:1,max:25},{rate:500,count:1,max:50},{rate:1e3,count:1,max:25},{rate:2e3,count:1,max:15}],lastSpawn:0}}];class ve{constructor(e){s(this,"groups",new Map),s(this,"scene"),this.scene=e;for(const t of xe)this.scene.load.spritesheet(t.TEXTURE_KEY,`assets/animations/${t.TEXTURE_KEY}.png`,{frameWidth:34,frameHeight:34}),this.groups.set(t.TEXTURE_KEY,new be(this.scene,t))}spawn(e,t){const s=this.groups.get(e);null==s||s.spawn(t)}update(e,t){const s=Math.floor(e/1e3),i=Math.floor(s/1e3);for(const[,a]of this.groups){const{info:{metadata:n}}=a,{startTime:r,spawn:o}=n,h=o[i]??o[o.length-1];if(!h)throw new Error("something's wrong");if(s>=r&&n.lastSpawn+h.rate<e){const t=h.max-a.countActive();a.spawn(Math.min(t,h.count)),n.lastSpawn=e}a.preUpdate(e,t)}}}const ke={attack:{duration:250,delay:150,cooldown:2e3,delta:0,speed:3840,range:2e3,damage:{start:9,end:15},projectiles:{total:2,fired:0,pierce:2},projectile:{vx:0,vy:0,vangular:0,pierce:Number.POSITIVE_INFINITY,projectiles:2,speed:800,duration:150,offsetAngle:0,range:0,damage:.1},deviation:Math.PI/32},damage:1};class Pe extends Phaser.Physics.Arcade.Sprite{constructor(e,t,i,a,n){super(e,t,i,"arrow"),s(this,"enemiesDamaged",[]),s(this,"pierce",0),s(this,"stats",ke),s(this,"created",!1),this.scene=e,this.rotation=a,e.add.existing(this),e.physics.add.existing(this),this.setRotation(a).setScale(Ee/3),this.setCollideWorldBounds(!0)}create(){if(this.created)return;const e=Math.cos(this.rotation),t=Math.sin(this.rotation),s=e*this.stats.attack.speed,i=t*this.stats.attack.speed;this.setVelocity(s,i),this.scene.time.addEvent({delay:this.stats.attack.range/this.stats.attack.speed*1e3,callback:()=>{this.destroy()}}),this.created=!0}update(e,t){if(this.create(),!this.scene.player)throw new n;const{left:s,top:i,width:a,height:r}=this.getBounds(),o=this.scene.physics.overlapRect(s,i,a,r);for(const n of o){const e=n.gameObject;e instanceof we&&(this.enemiesDamaged.includes(e)||(e.dealDamage(this.stats.damage),this.enemiesDamaged.push(e),this.pierce++,this.pierce>=this.stats.attack.projectiles.pierce&&this.destroy()))}}}const Se={attack:{duration:250,delay:150,cooldown:2e3,delta:0,speed:3840,range:2e3,damage:{start:9,end:15},projectiles:{total:2,fired:0,pierce:2},projectile:{vx:0,vy:0,vangular:800,pierce:Number.POSITIVE_INFINITY,projectiles:2,speed:800,duration:150,offsetAngle:800*Phaser.Math.DEG_TO_RAD*.15/2,range:0,damage:5},deviation:0},damage:5};let Me=class extends Phaser.Physics.Arcade.Sprite{constructor(e,t,i,a,n){super(e,t,i,"sword"),s(this,"enemiesDamaged",[]),s(this,"pierce",0),s(this,"stats",Se),s(this,"created",!1),this.scene=e,e.add.existing(this),e.physics.add.existing(this),this.stats.attack.projectile.vangular=this.stats.attack.projectile.vangular*n,this.setRotation(a).setScale(Ee).setOrigin(-.5,.5),this.setCollideWorldBounds(!0)}create(){this.created||(this.setVelocityX(this.stats.attack.projectile.vx),this.setVelocityY(this.stats.attack.projectile.vy),this.body instanceof Phaser.Physics.Arcade.Body&&(this.body.maxAngular=2160),this.setAngularVelocity(this.stats.attack.projectile.vangular),this.scene.time.addEvent({delay:this.stats.attack.projectile.duration,callback:()=>{this.destroy()}}),this.created=!0)}update(e,t){if(this.create(),!this.scene.player)throw new n;this.x=this.scene.player.x,this.y=this.scene.player.y;const{left:s,top:i,width:a,height:r}=this.getBounds(),o=this.scene.physics.overlapRect(s,i,a,r);for(const n of o){const e=n.gameObject;e instanceof we&&(this.enemiesDamaged.includes(e)||(e.dealDamage(this.stats.damage),this.enemiesDamaged.push(e),this.pierce++,this.pierce>=this.stats.attack.projectile.pierce&&this.destroy()))}}};class _e{constructor(e,t){if(s(this,"projectiles"),s(this,"keys"),s(this,"cone"),s(this,"arc"),this.scene=e,this.projectile=t,this.projectiles=this.scene.physics.add.group(),this.projectiles.runChildUpdate=!0,!this.scene.input.keyboard)throw new Error("why no keyboard?");this.keys={alt:this.scene.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.ALT)},this.cone=this.scene.add.graphics({lineStyle:{width:4,color:16711935,alpha:.1},fillStyle:{color:0,alpha:.05}}),this.arc=this.scene.add.graphics({lineStyle:{width:4,color:16777215,alpha:.5},fillStyle:{color:0,alpha:0}})}get stats(){switch(this.projectile){case"arrow":return ke;case"sword":return Se;default:throw new Error("invalid projectile")}}attack({x:e,y:t,angles:{actual:s}}){const{projectiles:i}=this.stats.attack,a=i.fired%2==0?-1:1;if("sword"===this.projectile){const i=new Me(this.scene,e,t,s,a);this.projectiles.add(i)}else{const i=new Pe(this.scene,e,t,s,a);this.projectiles.add(i)}}aim({angles:{target:e}}){var t;if(this.cone.clear(),!(null==(t=$.instance)?void 0:t.aiming))return;if(!this.scene.player)throw new n;const{deviation:s,range:i}=this.stats.attack,{player:a}=this.scene;this.cone.beginPath(),this.cone.arc(a.x,a.y,i,e-s,e+s,!1).strokePath().lineTo(a.x,a.y).fillPath()}position(e){if(!this.scene.player)throw new n;if(!$.instance)throw new Error;const{x:t,y:s,angle:i}=$.instance.target(this.scene.player),a=e+i,r=Math.random()*this.stats.attack.deviation*2-this.stats.attack.deviation,o=i+r,h=Math.cos(o),c=Math.sin(o),l=h*this.stats.attack.speed,d=c*this.stats.attack.speed;return{x:this.scene.player.x+40*h,y:this.scene.player.y+40*c,targetX:t,targetY:s,vx:l,vy:d,angles:{target:i,offset:a,actual:o,deviation:r}}}cooldown({targetX:e,targetY:t}){var s;if(this.arc.clear(),!(null==(s=$.instance)?void 0:s.aiming))return;const{attack:i}=this.stats,a=i.cooldown,n=1-Math.min(i.delta/a,1),r=2*Math.PI*n;this.arc.arc(e,t,50,0,r,!1).strokePath().fillPath()}update(e,t){const{attack:s}=this.stats,{projectiles:i}=s;s.delta+=t;const a=i.fired%2==0?-1:1,n=this.position(a*this.stats.attack.projectile.offsetAngle);this.aim(n),s.delta>=s.cooldown+(s.duration+s.delay)*i.fired&&(i.fired++,this.attack(n),i.fired>=i.total&&(s.delta=0,i.fired=0)),this.cooldown(n)}}const Ie=Math.PI/3,Te={attack:{duration:250,delay:150,cooldown:2e3,delta:0,damage:{start:9,end:15},projectiles:{total:2,fired:0,pierce:-1},deviation:0,speed:1e3,range:100},damage:5};class Ce{constructor(e,t=Te){var i,a;s(this,"hitbox"),s(this,"using","sword"),s(this,"tweens"),s(this,"rotation",{from:-60,center:0,to:60,offsetX:0,offsetY:0}),s(this,"enemiesDamaged",[]),s(this,"count",12),this.scene=e,this.stats=t,this.hitbox=e.add.sprite(0,0,"sword").setScale(Ee).setVisible(!1),null==(i=this.scene.GameLayer)||i.add(this.hitbox),null==(a=this.scene.input.keyboard)||a.addKey(Phaser.Input.Keyboard.KeyCodes.SPACE).on("up",()=>{switch(this.using){case"spear":this.using="sword";break;case"sword":this.using="spear"}});const n=this.scene.tweens.addCounter({paused:!0,persist:!0,from:0,to:100,ease:"back.in",delay:this.stats.attack.delay,duration:this.stats.attack.duration,onStart:()=>{this.onTweenStart()},onUpdate:(e,t,s,i,a)=>{const n=e.getValue();if(null===n)throw new Error("invalid tween");const r=this.rotation.center,o=Math.cos(r)*n,h=Math.sin(r)*n,c=i<a;this.position(this.rotation.center,o,h),this.collisions(!c)},onComplete:()=>{this.onTweenComplete()}}),r=this.scene.tweens.addCounter({paused:!0,persist:!0,from:-1*Ie,to:Ie,ease:"back.in",delay:this.stats.attack.delay,duration:this.stats.attack.duration,onStart:()=>{this.onTweenStart()},onUpdate:(e,t,s,i,a)=>{const n=e.getValue();if(null===n)throw new Error("invalid tween");const r=i<a;let o=this.rotation.center+n;this.stats.attack.projectiles.fired%2==0&&(o=this.rotation.center-n),this.position(o,this.rotation.offsetX,this.rotation.offsetY),this.collisions(!r)},onComplete:()=>{this.onTweenComplete()}});this.tweens={spear:n,sword:r}}get tween(){return this.tweens[this.using]}onTweenStart(){if(!this.scene.player)throw new n;if(!this.scene.enemies)throw new r("scene.enemies");const e=this.scene.physics.closest(this.scene.player,this.scene.enemies.getChildren());if(!(e instanceof we))throw new Error("");const t=Phaser.Math.Angle.Between(this.scene.player.x,this.scene.player.y,e.x,e.y);this.rotation={from:t-Math.PI/3,center:t,to:t+Math.PI/3,offsetX:40*Math.cos(t),offsetY:40*Math.sin(t)},this.position(t-Math.PI/3,0,0),this.hitbox.setVisible(!0)}onTweenComplete(){this.hitbox.setVisible(!1),this.enemiesDamaged=[],this.tween.pause().seek(0)}position(e,t,s){if(!this.scene.player)throw new n;this.hitbox.setOrigin(-.2,.5);const i=this.scene.player.x+t,a=this.scene.player.y+s;this.hitbox.setPosition(i,a),this.hitbox.setRotation(e)}positionForStaticAttack(e,t,s,i){if(!this.scene.player)throw new n;i&&this.hitbox.setFlipX(this.scene.player.flipX);const a=this.hitbox.flipX?-1:1,r=this.hitbox.flipX?1.2:-.2;this.hitbox.setOrigin(r,.5);const o=this.scene.player.x+t*a,h=this.scene.player.y+s;this.hitbox.setPosition(o,h),this.hitbox.setRotation(e*a)}collisions(e){if(!e)return;const{left:t,top:s,width:i,height:a}=this.hitbox.getBounds(),n=this.scene.physics.overlapRect(t,s,i,a);for(const r of n){const e=r.gameObject;e instanceof we&&(this.enemiesDamaged.includes(e)||(e.dealDamage(this.stats.damage),this.enemiesDamaged.push(e)))}}update(e,t){this.stats.attack.delta+=t;const{attack:s}=this.stats,{projectiles:i}=s;if(s.delta>=s.cooldown+(s.duration+s.delay)*i.fired){if(this.tween.isPlaying())return;i.fired++,this.tween.resume(),i.fired>=i.total&&(s.delta=0,i.fired=0)}}}const Ee=3;class Re extends Phaser.Physics.Arcade.Sprite{constructor(e,t,i,a){var n;if(super(e,t,i,a,void 0),s(this,"weapons",new Map),s(this,"active_weapon","bow"),s(this,"health",{curr:100,max:100}),s(this,"xp",{curr:0,max:10}),s(this,"level",1),s(this,"pause",!1),s(this,"velocity",160),s(this,"capture"),s(this,"hitbox",{}),s(this,"keys"),s(this,"alive",!0),this.scene=e,this.animations(),e.add.existing(this),e.physics.add.existing(this),null==(n=e.GameLayer)||n.add(this),this.setFriction(1),this.setScale(Ee),this.setCollideWorldBounds(!0),this.setBounce(1),e instanceof Fe&&(this.weapons.set("sword-tween",new Ce(e)),this.weapons.set("sword",new _e(e,"sword")),this.weapons.set("bow",new _e(e,"arrow"))),!this.scene.input.keyboard)throw new Error("why no keyboard?");this.keys={up1:this.scene.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.W),up2:this.scene.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.UP),left1:this.scene.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.A),left2:this.scene.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.LEFT),down1:this.scene.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.S),down2:this.scene.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.DOWN),right1:this.scene.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.D),right2:this.scene.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.RIGHT),tab:this.scene.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.TAB),rotateRight1:this.scene.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.E),rotateLeft1:this.scene.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.Q),updown:this.scene.input.keyboard.createCombo([Phaser.Input.Keyboard.KeyCodes.UP,Phaser.Input.Keyboard.KeyCodes.DOWN],{resetOnMatch:!0})},this.capture=this.scene.input.keyboard.addCapture([Phaser.Input.Keyboard.KeyCodes.UP,Phaser.Input.Keyboard.KeyCodes.LEFT])}physics(){const e=(this.width+10)*this.scaleX,t=(this.height+10)*this.scaleY,s=this.x-e/2,i=this.y-t/2;if(void 0===this.hitbox.loot){const a=this.scene.physics.add.body(s,i,e,t);return this.hitbox={loot:a},void(this.scene instanceof Fe&&this.scene.xp&&this.scene.physics.add.collider(a,this.scene.xp,(e,t)=>{t instanceof fe&&(this.xp.curr+=t.amount,t.destroy())}))}this.hitbox.loot.x=s,this.hitbox.loot.y=i}animations(){this.anims.create({key:"player-idle",frames:this.anims.generateFrameNumbers("char",{frames:[0,1]}),frameRate:4,repeat:-1}),this.anims.create({key:"player-move",frames:this.anims.generateFrameNumbers("char",{frames:[2,3]}),frameRate:4,repeat:-1})}die(){this.scene.scene.start(p),J.instance&&(J.instance.activeScene=p),this.alive&&(this.alive=!1,console.log("player dead"))}update(e,t){this.physics(),Z(this),(e=>{var t;e.xp.curr>=e.xp.max&&(e.xp.curr=e.xp.curr%e.xp.max,e.level+=1,e.xp.max=2*e.xp.max),e.xp.bar||(e.xp.bar=e.scene.add.graphics(),null==(t=e.scene.UILayer)||t.add(e.xp.bar)),e.xp.bar.clear();const s=e.x-50,i=e.y-100;e.xp.bar.fillStyle(2236962,1),e.xp.bar.fillRect(s,i,100,20);const a=100/e.xp.max;e.xp.bar.fillStyle(16777215,1),e.xp.bar.fillRect(s,i,Phaser.Math.Clamp(e.xp.curr*a,0,100),20)})(this);const s=this.weapons.get(this.active_weapon);if(s&&s.update(e,t),this.body instanceof Phaser.Physics.Arcade.Body){if(!$.instance){let e=0,t=0;const s=this.keys.up1.isDown||this.keys.up2.isDown,i=this.keys.left1.isDown||this.keys.left2.isDown,a=this.keys.down1.isDown||this.keys.down2.isDown,n=this.keys.right1.isDown||this.keys.right2.isDown,r=s||i||a||n;return i?this.flipX=!0:n&&(this.flipX=!1),r?this.play("player-move",!0):this.play("player-idle",!0),i&&(e-=160*Ee),n&&(e+=160*Ee),s&&(t-=160*Ee),a&&(t+=160*Ee),0!==e&&0!==t&&(e=Math.SQRT2*e/2,t=Math.SQRT2*t/2),void this.setVelocity(e,t)}{const[e,t]=$.instance.position();e<0&&(this.flipX=!0),0===e&&0===t?this.play("player-idle",!0):this.play("player-move",!0);const s=160*Ee,i=s*e,a=s*t;this.setVelocity(i,a)}}}}var De=Object.defineProperty,Ae=Object.getOwnPropertyDescriptor;class Fe extends Phaser.Scene{constructor(){super(u),s(this,"GameLayer",null),s(this,"UILayer",null),s(this,"MenuLayer",null),s(this,"player"),s(this,"enemyManager"),s(this,"enemies",null),s(this,"active",!0),s(this,"xp",null)}create(){var e;this.GameLayer=this.add.layer(),this.UILayer=this.add.layer(),this.MenuLayer=this.add.layer().setVisible(!1).setDepth(10),null==(e=this.input.mouse)||e.disableContextMenu(),this.player=new Re(this,this.scale.baseSize.width/2,this.scale.baseSize.height/2,"char"),this.enemies=this.physics.add.group(),this.enemyManager=new ve(this),this.xp=this.physics.add.group()}setActive(e){if(!this.GameLayer)throw new r("scene.GameLayer");if(!this.MenuLayer)throw new r("scene.MenuLayer");if(!this.UILayer)throw new r("scene.UILayer");if(!this.enemies)throw new r("scene.enemies");console.log(e),this.MenuLayer.setVisible(!e)}update(e,t){if(!this.player)throw new n;if(!this.enemyManager)throw new r("enemyManager");this.active&&(this.player.update(e,t),this.enemyManager.update(e,t))}}s(Fe,"key",""),((e,t,s)=>{for(var i,a=Ae(t,s),n=e.length-1;n>=0;n--)(i=e[n])&&(a=i(t,s,a)||a);a&&De(t,s,a)})([o()],Fe.prototype,"update");const Ke=(e,t)=>{e.level<=t&&(0===e.prerequisites.length||(e.level=t+1));for(const s of e.children)Ke(s,e.level)},Oe=e=>e.id.slice(0,e.id.lastIndexOf("_")),ze=(e,t)=>{if(t.availablePoints<e.cost)return!1;if((t.spent.get(e.id)??0)>=e.maxPoints)return!1;for(const s of e.prerequisites)if((t.spent.get(s.id)??0)<s.points)return!1;return!0},Be={damage_1:{id:"damage_1",name:"Damage I",description:"Increase base damage by 5%",cost:1,maxPoints:5,prerequisites:[],level:0},damage_2:{id:"damage_2",name:"Damage II",description:"Increase base damage by 10%",cost:2,maxPoints:5,prerequisites:[{id:"damage_1",points:1,total:5}],level:0},attack_speed_1:{id:"attack_speed_1",name:"Attack Speed I",description:"Increases attack speed by 10%",cost:1,maxPoints:5,prerequisites:[],level:0},attack_speed_2:{id:"attack_speed_2",name:"Attack Speed II",description:"Increases attack speed by 20%",cost:2,maxPoints:5,prerequisites:[{id:"attack_speed_1",points:1,total:5}],level:0},attack_speed_3:{id:"attack_speed_3",name:"Attack Speed III",description:"Increases attack speed by 30%",cost:3,maxPoints:3,prerequisites:[{id:"attack_speed_2",points:1,total:5}],level:0},attack_speed_4:{id:"attack_speed_4",name:"Attack Speed IV",description:"Massive increase to attack speed by 50%",cost:4,maxPoints:2,prerequisites:[{id:"attack_speed_3",points:1,total:5}],level:0},crit_chance_1:{id:"crit_chance_1",name:"Critical Chance I",description:"5% chance to deal double damage",cost:1,maxPoints:3,prerequisites:[{id:"damage_1",points:1,total:5}],level:2},crit_chance_2:{id:"crit_chance_2",name:"Critical Chance II",description:"+10% chance to critically hit",cost:3,maxPoints:2,prerequisites:[{id:"crit_chance_1",points:2}],level:4},crit_chance_3:{id:"crit_chance_3",name:"Critical Chance III",description:"Adds 15% more to critical chance",cost:3,maxPoints:1,prerequisites:[{id:"crit_chance_2",points:1,total:3}],level:0},crit_damage_1:{id:"crit_damage_1",name:"Critical Damage I",description:"Critical hits deal 50% more damage",cost:3,maxPoints:3,prerequisites:[{id:"crit_chance_1",points:1,total:3}],level:0},health_1:{id:"health_1",name:"Health I",description:"Increase maximum health by 10%",cost:1,maxPoints:5,prerequisites:[],level:0},health_2:{id:"health_2",name:"Health II",description:"Increase maximum health by 20%",cost:2,maxPoints:5,prerequisites:[{id:"health_1",points:1,total:5}],level:0},health_3:{id:"health_3",name:"Health III",description:"Increase maximum health by 30%",cost:3,maxPoints:5,prerequisites:[{id:"health_2",points:1,total:5}],level:0},health_4:{id:"health_4",name:"Health IV",description:"Massive increase to health by 50%",cost:5,maxPoints:3,prerequisites:[{id:"health_3",points:1,total:5}],level:0},armor_1:{id:"armor_1",name:"Armor I",description:"Increase armor by 10%",cost:2,maxPoints:5,prerequisites:[{id:"health_1",points:3}],level:2},armor_2:{id:"armor_2",name:"Armor II",description:"Increase armor by 10%",cost:2,maxPoints:5,prerequisites:[{id:"armor_1",points:1,total:5}],level:0},armor_3:{id:"armor_3",name:"Armor III",description:"Increase armor by 15%",cost:3,maxPoints:5,prerequisites:[{id:"armor_2",points:1,total:5}],level:0},armor_4:{id:"armor_4",name:"Armor IV",description:"Increase armor by 25%",cost:4,maxPoints:2,prerequisites:[{id:"armor_3",points:1,total:5}],level:0},mana_1:{id:"mana_1",name:"Mana I",description:"Increase mana pool by 10%",cost:1,maxPoints:5,prerequisites:[],level:0},mana_3:{id:"mana_3",name:"Mana III",description:"Increase mana regeneration by 10%",cost:3,maxPoints:5,prerequisites:[{id:"mana_2",points:1,total:5}],level:0},resource_efficiency:{id:"resource_efficiency",name:"Resource Efficiency",description:"Reduce resource consumption by 10%",cost:4,maxPoints:3,prerequisites:[{id:"mana_3",points:1,total:5}],level:0},health_regen_1:{id:"health_regen_1",name:"Health Regeneration I",description:"Regenerate health 5% faster",cost:1,maxPoints:5,prerequisites:[],level:0},health_regen_2:{id:"health_regen_2",name:"Health Regeneration II",description:"Regenerate health 10% faster",cost:2,maxPoints:5,prerequisites:[{id:"health_regen_1",points:1,total:5}],level:0},mana_regen_2:{id:"mana_regen_2",name:"Mana Regeneration II",description:"Regenerate mana 10% faster",cost:2,maxPoints:5,prerequisites:[{id:"mana_regen_1",points:1,total:5}],level:0},teleportation:{id:"teleportation",name:"Teleportation",description:"Unlocks teleportation ability",cost:10,maxPoints:1,prerequisites:[{id:"mana_2",points:1,total:5}],level:0},shield_ability:{id:"shield_ability",name:"Shield Ability",description:"Grants the ability to shield for 5 seconds",cost:8,maxPoints:1,prerequisites:[{id:"armor_2",points:1,total:5}],level:0},mana_2:{id:"mana_2",name:"Mana II",description:"Increase mana regen by 5%",cost:2,maxPoints:5,prerequisites:[{id:"mana_1",points:3}],level:1},damage_3:{id:"damage_3",name:"Damage III",description:"Increase damage by 15%",cost:3,maxPoints:5,prerequisites:[{id:"damage_2",points:3}],level:3},crit_damage_2:{id:"crit_damage_2",name:"Critical Damage II",description:"Crits deal +50% more damage",cost:3,maxPoints:3,prerequisites:[{id:"crit_damage_1",points:1},{id:"crit_chance_2",points:1}],level:5},mana_regen_1:{id:"mana_regen_1",name:"Mana Regen I",description:"Regenerate 5% mana/sec",cost:2,maxPoints:5,prerequisites:[{id:"mana_2",points:3}],level:3},damage_4:{id:"damage_4",name:"Damage IV",description:"Increases damage by 25%",cost:5,maxPoints:3,prerequisites:[{id:"damage_3",points:3}],level:5},berserk_mode:{id:"berserk_mode",name:"Berserk Mode",description:"Unlocks Berserk: +100% damage, -50% defense for 5s",cost:6,maxPoints:1,prerequisites:[{id:"damage_4",points:1}],level:7},shield_wall:{id:"shield_wall",name:"Shield Wall",description:"Activate to block 90% damage for 3 seconds",cost:6,maxPoints:1,prerequisites:[{id:"armor_1",points:3}],level:6},arcane_burst:{id:"arcane_burst",name:"Arcane Burst",description:"Unleash AoE spell consuming 50% mana",cost:6,maxPoints:1,prerequisites:[{id:"mana_regen_1",points:3}],level:6},precision_mastery:{id:"precision_mastery",name:"Precision Mastery",description:"Crits always do max damage",cost:7,maxPoints:1,prerequisites:[{id:"crit_damage_2",points:3},{id:"crit_chance_3",points:2}],level:8},overclock:{id:"overclock",name:"Overclock",description:"Temporarily double attack speed for 5 seconds (cooldown: 30s)",cost:8,maxPoints:1,prerequisites:[{id:"attack_speed_2",points:5}],level:8},divine_aegis:{id:"divine_aegis",name:"Divine Aegis",description:"One-time shield prevents fatal damage and heals 50%",cost:10,maxPoints:1,prerequisites:[{id:"shield_wall",points:1},{id:"health_1",points:5}],level:10},mana_overflow:{id:"mana_overflow",name:"Mana Overflow",description:"Grants double mana regen when under 30% mana",cost:7,maxPoints:1,prerequisites:[{id:"mana_regen_1",points:5}],level:8}},Le=120*Ee,je=70*Ee,Xe=[255,32896,32768,16776960,16753920,16744272,8900331,4251856,65280,14329120];class qe{constructor(e,t,i){var a;s(this,"tree"),s(this,"graphics"),s(this,"updateVisual",(e,t,s)=>{const i=this.state.spent.get(e.id)??0;i>0?t.setFillStyle(52326):ze(e,this.state)?t.setFillStyle(13421568):t.setFillStyle(6711039),s.setText(`${e.name}\n(${i}/${e.maxPoints})`)}),s(this,"i",0),s(this,"startOffset",new Map),s(this,"endOffset",new Map),this.scene=e,this.state=t,this.setState=i,this.menu(),this.graphics=e.add.graphics(),null==(a=e.MenuLayer)||a.add(this.graphics),this.tree=((e,t,s)=>{const i=(e=>{const t=(e=>{const t=new Map;for(const i of Object.values(e))for(const e of i.prerequisites){const s=t.get(e.id)??[];s.push(i.id),t.set(e.id,s)}const s=i=>{const a=e[i];return{...a,children:(t.get(i)??[]).map(s),level:a.level??0}};return Object.values(e).filter(e=>0===e.prerequisites.length).map(e=>s(e.id))})(e),s=t.reduce((e,t)=>(t.children.length>0&&e.push(t),e),[]);for(const i of s)Ke(i,0);return t})(e),a=new Map,n=new Map,r=({node:e,parentDepth:t})=>{var i,o;e.children.sort((t,s)=>{const i=Oe(t)===Oe(e),a=Oe(s)===Oe(e);return i&&!a?-1:a&&!i?1:0});const h=e.children.map(t=>r({node:t,parentDepth:e.level})),c=h[0],l=h[h.length-1];let d;if(0===h.length)d=a.get(e.level)??0;else if(1===h.length&&c){const t=c.column,s=a.get(e.level)??0;d=Math.max(t,s)}else if(c&&l){const t=(null==(i=h[e.children.findIndex(t=>Oe(t)===Oe(e))])?void 0:i.column)??Math.floor(c.column+l.column/2),s=a.get(e.level)??0;d=Math.max(t,s)}else console.log("wtf bro"),d=a.get(e.level)??0;d=Math.max(d,(null==(o=n.get(e.id))?void 0:o.col)??0);for(let s=t+1;s<=e.level;s++){const t=a.get(e.level)??0;a.set(s,Math.max(d+1,t))}return n.set(e.id,{...e,x:0,y:s.y+200+e.level*je,col:d}),{column:d}};i.forEach(e=>{r({node:e,parentDepth:-1})}),n.entries();let o=Number.MAX_SAFE_INTEGER,h=Number.MIN_SAFE_INTEGER;n.forEach(e=>{o=Math.min(e.col,o),h=Math.max(e.col,h)});const c=2*s.x+(t-200)/2-(h-o)*Le;return n.forEach(e=>{e.x=Math.max(s.x,c)+e.col*Le}),n})(Be,this.scene.scale.width-1200,{x:600,y:600});for(const[,s]of this.tree)this.placeUpgrade(s,this.tree)}menu(){if(!this.scene.MenuLayer)throw new r("scene.MenuLayer");const e=this.scene.add.rectangle(0,0,this.scene.scale.baseSize.width,this.scene.scale.baseSize.height,10592673,.5).setOrigin(0),t=this.scene.add.rectangle(600,600,this.scene.scale.baseSize.width-1200,this.scene.scale.baseSize.height-1200,1118481,.9).setOrigin(0);this.scene.MenuLayer.add(e),this.scene.MenuLayer.add(t)}placeUpgrade(e,t){var s,i;const a=e.x,n=e.y,r=this.scene.add.rectangle(a,n,100,50,6711039).setScale(Ee),o=this.scene.add.text(a,n,e.name,{fontSize:12*Ee+"px",color:"#ffffff"}).setOrigin(.5);null==(s=this.scene.MenuLayer)||s.add(r),null==(i=this.scene.MenuLayer)||i.add(o),r.setInteractive({useHandCursor:!0}).on("pointerdown",t=>{t.rightButtonDown()?((e,t,s)=>{if((t.spent.get(e.id)??0)<=0)return!1;for(const[,i]of s)for(const s of i.prerequisites)if(s.id===e.id){const e=t.spent.get(i.id)??0;if(e>0&&e>=s.points)return!1}return!0})(e,this.state,this.tree)&&(((e,t)=>{const s=t.spent.get(e.id)??0;s<=0||(t.spent.set(e.id,s-1),t.availablePoints+=e.cost)})(e,this.state),this.setState(this.state),this.updateVisual(e,r,o)):ze(e,this.state)&&(((e,t)=>{if(!ze(e,t))return;const s=t.spent.get(e.id)??0;t.availablePoints=t.availablePoints-e.cost,t.spent.set(e.id,s+1)})(e,this.state),this.setState(this.state),this.updateVisual(e,r,o))});for(const h of e.prerequisites){const e=t.get(h.id);if(!e)throw new Error("");const s=this.startOffset.get(`${e.x}:${e.y}`)??e.x,i=e.y+50*Ee/2,r=this.endOffset.get(`${a}:${n}`)??a,o=n-50*Ee/2;this.startOffset.set(`${e.x}:${e.y}`,s+25),this.endOffset.set(`${a}:${n}`,r-25),this.graphics.beginPath(),this.graphics.lineStyle(4,Xe[this.i++%Xe.length]),this.graphics.moveTo(s,i),this.graphics.lineTo(s,i+25),this.graphics.lineTo(r,i+25),this.graphics.lineTo(r,o),this.graphics.lineTo(r-10,o-10),this.graphics.lineTo(r+10,o-10),this.graphics.lineTo(r,o),this.graphics.strokePath()}}}class Ne extends Phaser.Scene{constructor(){super(p),s(this,"resourceManager"),s(this,"ResourceLayer",null),s(this,"GameLayer",null),s(this,"UILayer",null),s(this,"MenuLayer",null),s(this,"player"),s(this,"portalEnabled",!1)}create(){var e;this.ResourceLayer=this.add.layer(),this.GameLayer=this.add.layer(),this.UILayer=this.add.layer(),this.MenuLayer=this.add.layer(),null==(e=this.input.mouse)||e.disableContextMenu(),this.resourceManager=new U(this),this.setupAnimations();const t=this.physics.add.sprite(this.scale.baseSize.width/2,this.scale.baseSize.height/4,"portal").setOrigin(.5);t.play("portal-start"),t.on("animationcomplete",e=>{if(!(e instanceof Phaser.Animations.Animation))throw new Error("not an animation?");"portal-start"===e.key&&t.play("portal-enabled")}),this.player=new Re(this,this.scale.baseSize.width/2,this.scale.baseSize.height/2,"char"),this.resourceManager.initialize("stone"),this.physics.add.collider(this.player,t,()=>{this.scene.start(u),J.instance&&(J.instance.activeScene=u)})}preload(){this.anims.create({key:"portal-start",frames:this.anims.generateFrameNumbers("portal",{start:0,end:59}),frameRate:60,repeat:0}),this.anims.create({key:"portal-enabled",frames:this.anims.generateFrameNumbers("portal",{start:60}),frameRate:60,repeat:-1})}setupAnimations(){this.anims.create({key:"move",frames:this.anims.generateFrameNumbers("drone",{frames:[4,5]}),frameRate:8,repeat:-1}),this.anims.create({key:"smooth-move",frames:this.anims.generateFrameNumbers("blobie-walk",{start:0,end:7}),frameRate:16,repeat:-1}),this.anims.create({key:"idle",frames:this.anims.generateFrameNumbers("drone",{frames:[0,2]}),frameRate:4,repeat:-1}),this.anims.create({key:"idle2",frames:this.anims.generateFrameNumbers("drone",{frames:[1,3]}),frameRate:4,repeat:-1}),this.anims.create({key:"mine",frames:this.anims.generateFrameNumbers("drone",{frames:[0,2]}),frameRate:8,repeat:-1}),this.anims.create({key:"deliver",frames:this.anims.generateFrameNumbers("drone",{frames:[8,9]}),frameRate:8,repeat:-1})}update(e,t){var s,i;null==(s=this.resourceManager)||s.update(e,t),null==(i=this.player)||i.update(e,t)}}const Ue=[p,u,g];class Ve extends a.Scene{constructor(){super({key:h,visible:!1,active:!1}),s(this,"background"),s(this,"logo"),s(this,"title"),s(this,"menu"),s(this,"started",!1),s(this,"buttons",[]),s(this,"weapon",()=>{var e;const t=this.scene.get(u);if(!(t instanceof Fe))return;if(!(null==(e=t.player)?void 0:e.weapons))return;const s=t.player.weapons;let i=this.scale.baseSize.width/2-200*(s.size-1)-10*(s.size-1);for(const[a,n]of s){const e=this.add.rectangle(i,100,400,200,a===t.player.active_weapon?30464:16711680).setInteractive().on("pointerup",()=>{if(t.player){t.player.active_weapon=a;for(const t of this.buttons)t===e?t.setFillStyle(30464):t.setFillStyle(16711680)}}),s=this.add.text(i,100,a,{fontSize:40,color:"#ffffff",stroke:"#000000",strokeThickness:8,align:"center"}).setOrigin(.5);this.add.existing(e),this.add.existing(s),this.buttons.push(e),i+=410}}),s(this,"switchers",[]),s(this,"switcher",()=>{var e;let t=this.scale.baseSize.width/2-200*(Ue.length-1)-10*(Ue.length-1);const s=this.scale.baseSize.height-100;for(const i of Ue){const a=this.add.rectangle(t,s,400,200,i===(null==(e=J.instance)?void 0:e.activeScene)?30464:16711680).setInteractive().on("pointerup",()=>{var e;console.log(i),console.log(J.instance),null==(e=J.instance)||e.launch(i);for(const t of this.switchers)t===a?t.setFillStyle(30464):t.setFillStyle(16711680)}),n=this.add.text(t,s,i,{fontSize:40,color:"#ffffff",stroke:"#000000",strokeThickness:8,align:"center"}).setOrigin(.5);this.add.existing(a),this.add.existing(n),this.switchers.push(a),t+=410}})}create(){this.menu=this.add.rectangle(600,200,this.scale.baseSize.width-1200,this.scale.baseSize.height-400,1118481).setOrigin(0),this.weapon(),this.switcher()}}const $e={availablePoints:15,spent:new Map};class Ge extends Phaser.Scene{constructor(){super({key:c,visible:!1,active:!1}),s(this,"GameLayer",null),s(this,"UILayer",null),s(this,"MenuLayer",null)}create(){this.GameLayer=this.add.layer(),this.UILayer=this.add.layer(),this.MenuLayer=this.add.layer(),new qe(this,$e,()=>{console.log("setState")})}}class He extends Phaser.Plugins.BasePlugin{constructor(e){super(e),s(this,"alive"),this.alive=!0}isAlive(){return this.alive}}const We=[f,ye,Fe,Ne,Ge,R,Ve],Ye=a.Scale.FIT,Qe={type:a.AUTO,width:3840,height:2160,min:{width:720,height:720},scale:{mode:Ye,autoCenter:a.Scale.CENTER_BOTH},physics:{default:"arcade",arcade:{gravity:{x:0,y:0},debug:!1}},input:{gamepad:!0},parent:"game-container",plugins:{global:[{key:"Player",plugin:He,start:!1,mapping:"player"}]},scene:We};document.addEventListener("DOMContentLoaded",()=>{new a.Game({...Qe,parent:"game-container"})});
